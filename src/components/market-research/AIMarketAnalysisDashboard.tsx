'use client';

import React, { useState, useEffect } from 'react';
import Card from '@/basic/src/components/Card/Card';
import Button from '@/basic/src/components/Button/Button';
import Badge from '@/basic/src/components/Badge/Badge';
import { 
  TrendingUp, 
  Users, 
  Target,
  Search,
  RefreshCw,
  ChevronRight,
  AlertCircle,
  CheckCircle2,
  Clock,
  BarChart3,
  Lightbulb,
  Shield,
  Zap
} from 'lucide-react';
import { supabase } from '@/lib/supabase';

interface MarketAnalysisData {
  market_overview: {
    market_size: string;
    growth_rate: string;
    key_drivers: string[];
    market_maturity: string;
  };
  target_market: {
    primary_segment: string;
    secondary_segments: string[];
    market_needs: string[];
    pain_points: string[];
  };
  competitive_landscape: {
    direct_competitors: Array<{
      name: string;
      market_share: string;
      strengths: string[];
      weaknesses: string[];
      differentiation_opportunities: string[];
    }>;
    indirect_competitors: string[];
    competitive_advantages: string[];
  };
  market_trends: {
    current_trends: string[];
    emerging_trends: string[];
    technology_trends: string[];
    regulatory_trends: string[];
  };
  opportunities_threats: {
    opportunities: Array<{
      opportunity: string;
      impact: string;
      timeframe: string;
    }>;
    threats: Array<{
      threat: string;
      impact: string;
      mitigation: string;
    }>;
  };
  recommendations: {
    market_entry_strategy: string;
    positioning_strategy: string;
    pricing_strategy: string;
    marketing_channels: string[];
    success_metrics: string[];
  };
  next_steps: {
    immediate_actions: string[];
    research_priorities: string[];
    persona_analysis_focus: string[];
  };
}

interface MarketResearchRecord {
  id: string;
  project_id: string;
  rfp_analysis_id: string;
  analysis_data: MarketAnalysisData;
  question_responses: any[];
  ai_model_used: string;
  confidence_score: number;
  status: string;
  created_at: string;
}

interface AIMarketAnalysisDashboardProps {
  projectId: string;
  rfpAnalysisId?: string;
  onAnalysisComplete?: (analysis: MarketResearchRecord) => void;
}

export default function AIMarketAnalysisDashboard({
  projectId,
  rfpAnalysisId: _rfpAnalysisId,
  onAnalysisComplete: _onAnalysisComplete
}: AIMarketAnalysisDashboardProps) {
  const [marketResearch, setMarketResearch] = useState<MarketResearchRecord | null>(null);
  const [loading, setLoading] = useState(false);
  const [activeTab, setActiveTab] = useState('overview');
  const [analysisHistory, setAnalysisHistory] = useState<MarketResearchRecord[]>([]);
  
  // RFP Î∂ÑÏÑù Í≤∞Í≥º ÏÑ†ÌÉù Í¥ÄÎ†® ÏÉÅÌÉú
  const [showRFPSelector, setShowRFPSelector] = useState(false);
  const [availableRFPAnalyses, setAvailableRFPAnalyses] = useState<any[]>([]);
  const [_selectedRFPAnalysis, setSelectedRFPAnalysis] = useState<any>(null);

  // RFP Î∂ÑÏÑù Í≤∞Í≥º Ï°∞Ìöå Ìï®Ïàò
  const loadAvailableRFPAnalyses = React.useCallback(async () => {
    try {
      console.log('üîç [RFPÏÑ†ÌÉù] RFP Î∂ÑÏÑù Í≤∞Í≥º Ï°∞Ìöå ÏãúÏûë:', { projectId });
      
      const { data, error } = await (supabase as any)
        .from('rfp_analyses')
        .select(`
          id,
          analysis_data,
          created_at,
          follow_up_questions (
            id,
            question_text,
            user_answer,
            ai_generated_answer,
            answer_type
          )
        `)
        .eq('project_id', projectId)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('‚ùå [RFPÏÑ†ÌÉù] RFP Î∂ÑÏÑù Í≤∞Í≥º Ï°∞Ìöå Ïò§Î•ò:', error);
        return;
      }

      console.log('‚úÖ [RFPÏÑ†ÌÉù] RFP Î∂ÑÏÑù Í≤∞Í≥º Ï°∞Ìöå ÏôÑÎ£å:', data?.length, 'Í±¥');
      setAvailableRFPAnalyses(data || []);
    } catch (error) {
      console.error('‚ùå [RFPÏÑ†ÌÉù] RFP Î∂ÑÏÑù Ï°∞Ìöå Ïã§Ìå®:', error);
    }
  }, [projectId]);

  // RFP Î∂ÑÏÑù ÏÑ†ÌÉù ÌõÑ ÏãúÏû•Ï°∞ÏÇ¨ Ïã§Ìñâ Ìï®Ïàò
  const runMarketAnalysisFromRFP = async (rfpAnalysis: any) => {
    try {
      setLoading(true);
      console.log('üöÄ [ÏãúÏû•Ï°∞ÏÇ¨] RFP Î∂ÑÏÑù Í∏∞Î∞ò ÏãúÏû•Ï°∞ÏÇ¨ ÏãúÏûë:', rfpAnalysis.id);

      // ÌõÑÏÜç ÏßàÎ¨∏ ÎãµÎ≥Ä Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
      const questionResponses = (rfpAnalysis.follow_up_questions || [])
        .filter((q: any) => {
          const hasUserAnswer = q.user_answer?.trim();
          const hasAIAnswer = q.ai_generated_answer?.trim();
          return hasUserAnswer || hasAIAnswer;
        })
        .map((q: any) => {
          const finalAnswer = q.answer_type === 'ai' ? q.ai_generated_answer : q.user_answer;
          return {
            question_id: q.id,
            question_text: q.question_text,
            response: finalAnswer,
            category: 'general'
          };
        });

      console.log('üìù [ÏãúÏû•Ï°∞ÏÇ¨] ÏßàÎ¨∏-ÎãµÎ≥Ä Îç∞Ïù¥ÌÑ∞:', questionResponses.length, 'Í∞ú');

      if (questionResponses.length === 0) {
        alert('ÌõÑÏÜç ÏßàÎ¨∏Ïóê ÎãµÎ≥ÄÏù¥ ÏóÜÏäµÎãàÎã§. RFP Î∂ÑÏÑù Í≤∞Í≥ºÏóêÏÑú ÌõÑÏÜç ÏßàÎ¨∏Ïóê Î®ºÏ†Ä ÎãµÎ≥ÄÌï¥ Ï£ºÏÑ∏Ïöî.');
        return;
      }

      // ÏãúÏû•Ï°∞ÏÇ¨ API Ìò∏Ï∂ú
      const response = await fetch('/api/market-research/ai-analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          project_id: projectId,
          rfp_analysis_id: rfpAnalysis.id,
          question_responses: questionResponses,
          selected_model_id: 'claude-3-5-sonnet-20241022'
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`ÏãúÏû•Ï°∞ÏÇ¨ Î∂ÑÏÑù Ïã§Ìå®: ${errorData.error || 'Unknown error'}`);
      }

      const result = await response.json();
      console.log('‚úÖ [ÏãúÏû•Ï°∞ÏÇ¨] Î∂ÑÏÑù ÏôÑÎ£å:', result);

      // Î∂ÑÏÑù ÏôÑÎ£å ÌõÑ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
      await loadAnalysisHistory();
      setShowRFPSelector(false);
      setSelectedRFPAnalysis(rfpAnalysis);
      
      alert('ÏãúÏû•Ï°∞ÏÇ¨ Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
    } catch (error) {
      console.error('‚ùå [ÏãúÏû•Ï°∞ÏÇ¨] Î∂ÑÏÑù Ïã§Ìå®:', error);
      alert(`ÏãúÏû•Ï°∞ÏÇ¨ Î∂ÑÏÑù Ïã§Ìå®: ${error instanceof Error ? error.message : String(error)}`);
    } finally {
      setLoading(false);
    }
  };

  const loadAnalysisHistory = React.useCallback(async () => {
    try {
      console.log('üîç [ÏãúÏû•Ï°∞ÏÇ¨] Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏãúÏûë:', { projectId });
      
      // 2Ï∞® AI Î∂ÑÏÑùÏóêÏÑú ÏÉùÏÑ±Îêú ÏãúÏû• Ï°∞ÏÇ¨ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (Ï†ïÌôïÌïú ÌÖåÏù¥Î∏îÎ™Ö ÏÇ¨Ïö©)
      const { data, error } = await (supabase as any)
        .from('market_research')
        .select('*')
        .eq('project_id', projectId)
        .order('created_at', { ascending: false })
        .limit(10);

      if (error) {
        console.error('ÏãúÏû• Ï°∞ÏÇ¨ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò:', error);
        throw error;
      }

      console.log('üìä [ÏãúÏû•Ï°∞ÏÇ¨] Ï°∞ÌöåÎêú Îç∞Ïù¥ÌÑ∞:', data?.length, 'Í±¥');
      
      // 2Ï∞® AI Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Ï°¥ ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò (ÏïàÏ†ÑÌïú Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨)
      const formattedData = data?.map((item: any) => {
        try {
          // Í∏∞Î≥∏Í∞íÏúºÎ°ú Îπà Í∞ùÏ≤¥ ÏÑ§Ï†ïÌïòÏó¨ null/undefined Ïò§Î•ò Î∞©ÏßÄ
          const marketOverview = item.market_overview || {};
          const targetMarket = item.target_market || {};
          const competitorAnalysis = item.competitor_analysis || {};
          const marketTrends = item.market_trends || [];
          const opportunities = item.opportunities || [];
          const threats = item.threats || [];
          const recommendations = item.recommendations || [];

          return {
            id: item.id || '',
            project_id: item.project_id || projectId,
            rfp_analysis_id: item.rfp_analysis_id || '',
            analysis_data: {
              market_overview: {
                market_size: marketOverview.market_size || 'Î∂ÑÏÑù Ï§ë',
                growth_rate: marketOverview.growth_rate || 'Î∂ÑÏÑù Ï§ë', 
                key_drivers: Array.isArray(marketOverview.market_drivers) ? marketOverview.market_drivers : [],
                market_maturity: marketOverview.market_maturity || 'Î∂ÑÏÑù Ï§ë'
              },
              target_market: {
                primary_segment: targetMarket.primary_segments?.[0] || targetMarket.primary_segment || 'Î∂ÑÏÑù Ï§ë',
                secondary_segments: Array.isArray(targetMarket.secondary_segments) ? targetMarket.secondary_segments : [],
                market_needs: Array.isArray(targetMarket.market_needs) ? targetMarket.market_needs : [],
                pain_points: Array.isArray(targetMarket.pain_points) ? targetMarket.pain_points : []
              },
              competitive_landscape: {
                direct_competitors: Array.isArray(competitorAnalysis.direct_competitors) ? competitorAnalysis.direct_competitors : [],
                indirect_competitors: Array.isArray(competitorAnalysis.indirect_competitors) ? competitorAnalysis.indirect_competitors : [],
                competitive_advantages: Array.isArray(competitorAnalysis.competitive_advantages) ? competitorAnalysis.competitive_advantages : []
              },
              market_trends: {
                current_trends: Array.isArray(marketTrends) ? marketTrends.map((t: any) => (typeof t === 'object' && t.trend) ? t.trend : String(t)) : [],
                emerging_trends: [],
                technology_trends: [],
                regulatory_trends: []
              },
              opportunities_threats: {
                opportunities: Array.isArray(opportunities) ? opportunities : [],
                threats: Array.isArray(threats) ? threats : []
              },
              recommendations: {
                market_entry_strategy: (Array.isArray(recommendations) && recommendations.length > 0) ? (recommendations[0]?.recommendation || String(recommendations[0]) || '') : '',
                positioning_strategy: '',
                pricing_strategy: '',
                marketing_channels: [],
                success_metrics: []
              },
              next_steps: {
                immediate_actions: [],
                research_priorities: [],
                persona_analysis_focus: []
              }
            },
            question_responses: [],
            ai_model_used: 'Claude 3.5 Sonnet',
            confidence_score: typeof item.confidence_score === 'number' ? item.confidence_score : 0.8,
            status: item.status || 'completed',
            created_at: item.created_at || new Date().toISOString()
          };
        } catch (itemError) {
          console.error('‚ùå [ÏãúÏû•Ï°∞ÏÇ¨] Í∞úÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò Ïò§Î•ò:', itemError, item);
          return null;
        }
      }).filter(Boolean) || []; // null Ìï≠Î™© Ï†úÍ±∞

      setAnalysisHistory(formattedData);
      if (formattedData.length > 0) {
        setMarketResearch(formattedData[0]);
        console.log('‚úÖ [ÏãúÏû•Ï°∞ÏÇ¨] ÏµúÏã† Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï ÏôÑÎ£å');
      } else {
        console.log('üìù [ÏãúÏû•Ï°∞ÏÇ¨] Î∂ÑÏÑù Í≤∞Í≥º ÏóÜÏùå');
      }
    } catch (error) {
      console.error('‚ùå [ÏãúÏû•Ï°∞ÏÇ¨] Ïù¥Î†• Î°úÎî© Ïò§Î•ò:', error);
    }
  }, [projectId]);

  useEffect(() => {
    loadAnalysisHistory();
    loadAvailableRFPAnalyses();
  }, [loadAnalysisHistory, loadAvailableRFPAnalyses]);

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'completed':
        return <CheckCircle2 className="w-4 h-4 text-green-500" />;
      case 'in_progress':
        return <RefreshCw className="w-4 h-4 text-blue-500 animate-spin" />;
      case 'pending':
        return <Clock className="w-4 h-4 text-gray-500" />;
      case 'failed':
        return <AlertCircle className="w-4 h-4 text-red-500" />;
      default:
        return null;
    }
  };

  // RFP Î∂ÑÏÑù ÏÑ†ÌÉù Î™®Îã¨ Î†åÎçîÎßÅ
  const renderRFPSelector = () => (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
        <div className="p-6">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-semibold">RFP Î∂ÑÏÑù Í≤∞Í≥º ÏÑ†ÌÉù</h3>
            <Button
              onClick={() => setShowRFPSelector(false)}
              className="text-gray-400 hover:text-gray-600"
            >
              ‚úï
            </Button>
          </div>
          
          <p className="text-gray-600 mb-6">
            ÏãúÏû•Ï°∞ÏÇ¨Î•º ÏßÑÌñâÌï† RFP Î∂ÑÏÑù Í≤∞Í≥ºÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. ÌõÑÏÜç ÏßàÎ¨∏Ïóê ÎãµÎ≥ÄÏù¥ ÏûàÎäî Î∂ÑÏÑùÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.
          </p>

          <div className="space-y-3">
            {availableRFPAnalyses.map((rfpAnalysis: any) => {
              const answeredQuestions = (rfpAnalysis.follow_up_questions || []).filter((q: any) => 
                q.user_answer?.trim() || q.ai_generated_answer?.trim()
              );
              const totalQuestions = rfpAnalysis.follow_up_questions?.length || 0;
              const hasAnswers = answeredQuestions.length > 0;

              return (
                <Card key={rfpAnalysis.id} className="p-4 hover:bg-gray-50 cursor-pointer border">
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h4 className="font-medium">RFP Î∂ÑÏÑù Í≤∞Í≥º</h4>
                        <Badge className={hasAnswers ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}>
                          {hasAnswers ? 'ÎãµÎ≥Ä ÏôÑÎ£å' : 'ÎãµÎ≥Ä ÌïÑÏöî'}
                        </Badge>
                      </div>
                      <p className="text-sm text-gray-600 mb-2">
                        ÏÉùÏÑ±Ïùº: {new Date(rfpAnalysis.created_at).toLocaleDateString('ko-KR')}
                      </p>
                      <p className="text-sm text-gray-600">
                        ÌõÑÏÜç ÏßàÎ¨∏: {answeredQuestions.length}/{totalQuestions}Í∞ú ÎãµÎ≥Ä ÏôÑÎ£å
                      </p>
                    </div>
                    <Button
                      onClick={() => runMarketAnalysisFromRFP(rfpAnalysis)}
                      disabled={!hasAnswers || loading}
                      className={`ml-4 ${hasAnswers ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}`}
                    >
                      {loading ? <RefreshCw className="w-4 h-4 animate-spin" /> : 'ÏãúÏû•Ï°∞ÏÇ¨ Ïã§Ìñâ'}
                    </Button>
                  </div>
                </Card>
              );
            })}
          </div>

          {availableRFPAnalyses.length === 0 && (
            <div className="text-center py-8 text-gray-500">
              <AlertCircle className="w-8 h-8 mx-auto mb-2" />
              <p>ÏÇ¨Ïö© Í∞ÄÎä•Ìïú RFP Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );

  const renderOverview = () => {
    if (!marketResearch || !marketResearch.analysis_data) {
      return (
        <div className="text-center py-12">
          <Search className="w-12 h-12 text-gray-400 mx-auto mb-4" />
          <h3 className="text-lg font-semibold mb-2">ÏãúÏû•Ï°∞ÏÇ¨ Î∂ÑÏÑù ÏãúÏûë</h3>
          <p className="text-gray-600 mb-6">
            RFP Î∂ÑÏÑù Í≤∞Í≥ºÎ•º ÏÑ†ÌÉùÌïòÏó¨ AI ÏãúÏû•Ï°∞ÏÇ¨Î•º ÏßÑÌñâÌïòÍ±∞ÎÇò, ÏßÅÏ†ë ÏûêÎ£åÎ•º ÏûÖÎ†•ÌïòÏó¨ Î∂ÑÏÑùÌï† Ïàò ÏûàÏäµÎãàÎã§.
          </p>
          <div className="flex gap-4 justify-center">
            <Button 
              onClick={() => setShowRFPSelector(true)}
              className="bg-blue-600 text-white flex items-center gap-2"
            >
              <Search className="w-4 h-4" />
              RFP Î∂ÑÏÑù Í≤∞Í≥º ÏÑ†ÌÉù
            </Button>
            <Button className="border border-gray-300 text-gray-700">
              ÏßÅÏ†ë ÏûêÎ£å ÏûÖÎ†•
            </Button>
          </div>
        </div>
      );
    }

    const analysis = marketResearch.analysis_data;

    return (
      <div className="space-y-6">
        {/* Î∂ÑÏÑù ÏÉÅÌÉú Ìó§Îçî */}
        <div className="flex items-center justify-between">
          <div>
            <h3 className="text-lg font-semibold">AI ÏãúÏû• Ï°∞ÏÇ¨ Î∂ÑÏÑù</h3>
            <p className="text-sm text-gray-600">
              {marketResearch.ai_model_used}Î°ú Î∂ÑÏÑù ‚Ä¢ {new Date(marketResearch.created_at).toLocaleDateString()}
            </p>
          </div>
          <div className="flex items-center gap-2">
            {getStatusIcon(marketResearch.status)}
            <Badge variant={marketResearch.status === 'completed' ? 'primary' : 'secondary'}>
              {marketResearch.status}
            </Badge>
            <Badge variant="default">
              Ïã†Î¢∞ÎèÑ {(marketResearch.confidence_score * 100).toFixed(0)}%
            </Badge>
          </div>
        </div>

        {/* ÏãúÏû• Í∞úÏöî Ïπ¥Îìú */}
        <Card className="bg-white border border-gray-200">
          <div className="mb-4">
            <h4 className="text-base font-semibold flex items-center gap-2">
              <BarChart3 className="w-5 h-5 text-blue-600" />
              ÏãúÏû• Í∞úÏöî
            </h4>
          </div>
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-600 mb-1">ÏãúÏû• Í∑úÎ™®</p>
                <p className="font-semibold">{analysis.market_overview?.market_size}</p>
              </div>
              <div>
                <p className="text-sm text-gray-600 mb-1">ÏÑ±Ïû•Î•†</p>
                <p className="font-semibold text-green-600">{analysis.market_overview?.growth_rate}</p>
              </div>
            </div>
            <div>
              <p className="text-sm text-gray-600 mb-1">ÏãúÏû• ÏÑ±ÏàôÎèÑ</p>
              <p className="font-semibold">{analysis.market_overview?.market_maturity}</p>
            </div>
            <div>
              <p className="text-sm text-gray-600 mb-2">Ï£ºÏöî ÏÑ±Ïû• ÎèôÎ†•</p>
              <ul className="space-y-1">
                {Array.isArray(analysis.market_overview?.key_drivers) && analysis.market_overview.key_drivers.length > 0 ? (
                  analysis.market_overview.key_drivers.map((driver, index) => (
                    <li key={index} className="flex items-start gap-2 text-sm">
                      <ChevronRight className="w-4 h-4 mt-0.5 text-blue-500 flex-shrink-0" />
                      <span>{String(driver)}</span>
                    </li>
                  ))
                ) : (
                  <li className="text-sm text-gray-500">ÏÑ±Ïû• ÎèôÎ†• Î∂ÑÏÑù Ï§ë...</li>
                )}
              </ul>
            </div>
          </div>
        </Card>

        {/* ÌÜµÍ≥Ñ Ïπ¥Îìú Í∑∏Î¶¨Îìú */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <Card className="bg-white border border-gray-200">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-blue-100 rounded-lg">
                <Users className="w-5 h-5 text-blue-600" />
              </div>
              <div>
                <p className="text-sm text-gray-600">ÏßÅÏ†ë Í≤ΩÏüÅÏÇ¨</p>
                <p className="text-xl font-semibold">
                  {analysis.competitive_landscape?.direct_competitors?.length || 0}
                </p>
              </div>
            </div>
          </Card>

          <Card className="bg-white border border-gray-200">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-green-100 rounded-lg">
                <TrendingUp className="w-5 h-5 text-green-600" />
              </div>
              <div>
                <p className="text-sm text-gray-600">ÏãúÏû• Ìä∏Î†åÎìú</p>
                <p className="text-xl font-semibold">
                  {analysis.market_trends?.current_trends?.length || 0}
                </p>
              </div>
            </div>
          </Card>

          <Card className="bg-white border border-gray-200">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-purple-100 rounded-lg">
                <Lightbulb className="w-5 h-5 text-purple-600" />
              </div>
              <div>
                <p className="text-sm text-gray-600">Í∏∞Ìöå ÏöîÏÜå</p>
                <p className="text-xl font-semibold">
                  {analysis.opportunities_threats?.opportunities?.length || 0}
                </p>
              </div>
            </div>
          </Card>

          <Card className="bg-white border border-gray-200">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-orange-100 rounded-lg">
                <Target className="w-5 h-5 text-orange-600" />
              </div>
              <div>
                <p className="text-sm text-gray-600">ÌÉÄÍ≤ü ÏÑ∏Í∑∏Î®ºÌä∏</p>
                <p className="text-xl font-semibold">
                  {analysis.target_market?.secondary_segments?.length ? analysis.target_market.secondary_segments.length + 1 : 1}
                </p>
              </div>
            </div>
          </Card>
        </div>

        {/* Ï∂îÏ≤úÏÇ¨Ìï≠ */}
        {analysis.recommendations && (
          <Card className="bg-white border border-gray-200">
            <div className="mb-4">
              <h4 className="text-base font-semibold flex items-center gap-2">
                <Zap className="w-5 h-5 text-yellow-600" />
                AI Ï∂îÏ≤úÏÇ¨Ìï≠
              </h4>
            </div>
            <div className="space-y-4">
              <div>
                <p className="text-sm text-gray-600 mb-1">ÏãúÏû• ÏßÑÏûÖ Ï†ÑÎûµ</p>
                <p className="font-medium">{analysis.recommendations.market_entry_strategy}</p>
              </div>
              <div>
                <p className="text-sm text-gray-600 mb-1">Ìè¨ÏßÄÏÖîÎãù Ï†ÑÎûµ</p>
                <p className="font-medium">{analysis.recommendations.positioning_strategy}</p>
              </div>
              <div>
                <p className="text-sm text-gray-600 mb-2">Ï¶âÏãú Ïã§Ìñâ Ïï°ÏÖò</p>
                <ul className="space-y-1">
                  {analysis.next_steps?.immediate_actions?.slice(0, 3).map((action, index) => (
                    <li key={index} className="flex items-start gap-2 text-sm">
                      <ChevronRight className="w-4 h-4 mt-0.5 text-green-500 flex-shrink-0" />
                      <span>{action}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </Card>
        )}
      </div>
    );
  };

  const renderCompetitorAnalysis = () => {
    if (!marketResearch?.analysis_data?.competitive_landscape) {
      return <div className="text-center py-8 text-gray-500">Í≤ΩÏüÅÏÇ¨ Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>;
    }

    const competitors = marketResearch.analysis_data.competitive_landscape;

    return (
      <div className="space-y-6">
        {/* ÏßÅÏ†ë Í≤ΩÏüÅÏÇ¨ */}
        <div className="space-y-4">
          <h4 className="text-lg font-semibold">ÏßÅÏ†ë Í≤ΩÏüÅÏÇ¨</h4>
          {Array.isArray(competitors.direct_competitors) && competitors.direct_competitors.length > 0 ? (
            competitors.direct_competitors.map((competitor, index) => (
            <Card key={index} className="bg-white border border-gray-200">
              <div className="space-y-3">
                <div className="flex items-center justify-between">
                  <h5 className="font-semibold text-base">{competitor.name}</h5>
                  <Badge variant="secondary">Ï†êÏú†Ïú®: {competitor.market_share}</Badge>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600 mb-2 font-medium">Í∞ïÏ†ê</p>
                    <ul className="space-y-1">
                      {Array.isArray(competitor.strengths) && competitor.strengths.length > 0 ? (
                        competitor.strengths.map((strength, idx) => (
                          <li key={idx} className="text-sm flex items-start gap-2">
                            <ChevronRight className="w-3 h-3 mt-1 text-green-500" />
                            {String(strength)}
                          </li>
                        ))
                      ) : (
                        <li className="text-sm text-gray-500">Í∞ïÏ†ê Î∂ÑÏÑù Ï§ë...</li>
                      )}
                    </ul>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600 mb-2 font-medium">ÏïΩÏ†ê</p>
                    <ul className="space-y-1">
                      {Array.isArray(competitor.weaknesses) && competitor.weaknesses.length > 0 ? (
                        competitor.weaknesses.map((weakness, idx) => (
                          <li key={idx} className="text-sm flex items-start gap-2">
                            <ChevronRight className="w-3 h-3 mt-1 text-red-500" />
                            {String(weakness)}
                          </li>
                        ))
                      ) : (
                        <li className="text-sm text-gray-500">ÏïΩÏ†ê Î∂ÑÏÑù Ï§ë...</li>
                      )}
                    </ul>
                  </div>
                </div>
              </div>
            </Card>
            ))
          ) : (
            <div className="text-center py-8 text-gray-500">ÏßÅÏ†ë Í≤ΩÏüÅÏÇ¨ Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>
          )}
        </div>

        {/* Í≤ΩÏüÅ Ïö∞ÏúÑ */}
        {competitors.competitive_advantages?.length > 0 && (
          <Card className="bg-white border border-gray-200">
            <div className="mb-4">
              <h4 className="text-base font-semibold flex items-center gap-2">
                <Shield className="w-5 h-5 text-green-600" />
                Ïö∞Î¶¨Ïùò Í≤ΩÏüÅ Ïö∞ÏúÑ
              </h4>
            </div>
            <ul className="space-y-2">
              {competitors.competitive_advantages.map((advantage, index) => (
                <li key={index} className="flex items-start gap-2 text-sm">
                  <ChevronRight className="w-4 h-4 mt-0.5 text-blue-500 flex-shrink-0" />
                  <span>{advantage}</span>
                </li>
              ))}
            </ul>
          </Card>
        )}
      </div>
    );
  };

  const renderMarketTrends = () => {
    if (!marketResearch?.analysis_data?.market_trends) {
      return <div className="text-center py-8 text-gray-500">ÏãúÏû• Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>;
    }

    const trends = marketResearch.analysis_data.market_trends;

    return (
      <div className="space-y-6">
        {trends.current_trends?.length > 0 && (
          <Card className="bg-white border border-gray-200">
            <div className="mb-4">
              <h4 className="text-base font-semibold">ÌòÑÏû¨ Ìä∏Î†åÎìú</h4>
            </div>
            <ul className="space-y-2">
              {trends.current_trends.map((trend, index) => (
                <li key={index} className="flex items-start gap-2 text-sm">
                  <TrendingUp className="w-4 h-4 mt-0.5 text-blue-500 flex-shrink-0" />
                  <span>{trend}</span>
                </li>
              ))}
            </ul>
          </Card>
        )}

        {trends.emerging_trends?.length > 0 && (
          <Card className="bg-white border border-gray-200">
            <div className="mb-4">
              <h4 className="text-base font-semibold">Ïã†Ìù• Ìä∏Î†åÎìú</h4>
            </div>
            <ul className="space-y-2">
              {trends.emerging_trends.map((trend, index) => (
                <li key={index} className="flex items-start gap-2 text-sm">
                  <Zap className="w-4 h-4 mt-0.5 text-purple-500 flex-shrink-0" />
                  <span>{trend}</span>
                </li>
              ))}
            </ul>
          </Card>
        )}

        {trends.technology_trends?.length > 0 && (
          <Card className="bg-white border border-gray-200">
            <div className="mb-4">
              <h4 className="text-base font-semibold">Í∏∞Ïà† Ìä∏Î†åÎìú</h4>
            </div>
            <ul className="space-y-2">
              {trends.technology_trends.map((trend, index) => (
                <li key={index} className="flex items-start gap-2 text-sm">
                  <ChevronRight className="w-4 h-4 mt-0.5 text-green-500 flex-shrink-0" />
                  <span>{trend}</span>
                </li>
              ))}
            </ul>
          </Card>
        )}
      </div>
    );
  };

  const renderOpportunitiesThreats = () => {
    if (!marketResearch?.analysis_data?.opportunities_threats) {
      return <div className="text-center py-8 text-gray-500">Í∏∞Ìöå/ÏúÑÌóò Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>;
    }

    const ot = marketResearch.analysis_data.opportunities_threats;

    return (
      <div className="space-y-6">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Í∏∞Ìöå ÏöîÏÜå */}
          <Card className="bg-white border border-gray-200">
            <div className="mb-4">
              <h4 className="text-base font-semibold flex items-center gap-2">
                <Lightbulb className="w-5 h-5 text-yellow-600" />
                Í∏∞Ìöå ÏöîÏÜå
              </h4>
            </div>
            <div className="space-y-3">
              {ot.opportunities?.map((opp, index) => (
                <div key={index} className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                  <div className="flex items-center justify-between mb-2">
                    <Badge variant={opp.impact === 'high' ? 'primary' : opp.impact === 'medium' ? 'secondary' : 'default'}>
                      {opp.impact} ÏòÅÌñ•ÎèÑ
                    </Badge>
                    <span className="text-xs text-gray-600">{opp.timeframe}</span>
                  </div>
                  <p className="text-sm font-medium">{opp.opportunity}</p>
                </div>
              ))}
            </div>
          </Card>

          {/* ÏúÑÌóò ÏöîÏÜå */}
          <Card className="bg-white border border-gray-200">
            <div className="mb-4">
              <h4 className="text-base font-semibold flex items-center gap-2">
                <AlertCircle className="w-5 h-5 text-red-600" />
                ÏúÑÌóò ÏöîÏÜå
              </h4>
            </div>
            <div className="space-y-3">
              {ot.threats?.map((threat, index) => (
                <div key={index} className="p-3 bg-red-50 border border-red-200 rounded-lg">
                  <div className="flex items-center justify-between mb-2">
                    <Badge variant={threat.impact === 'high' ? 'primary' : threat.impact === 'medium' ? 'secondary' : 'default'}>
                      {threat.impact} ÏòÅÌñ•ÎèÑ
                    </Badge>
                  </div>
                  <p className="text-sm font-medium mb-2">{threat.threat}</p>
                  <p className="text-xs text-gray-600">ÏôÑÌôîÎ∞©Ïïà: {threat.mitigation}</p>
                </div>
              ))}
            </div>
          </Card>
        </div>
      </div>
    );
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold">AI ÏãúÏû• Ï°∞ÏÇ¨ Î∂ÑÏÑù</h2>
          <p className="text-gray-600">RFP Î∂ÑÏÑùÍ≥º ÌõÑÏÜç ÏßàÎ¨∏ÏùÑ Í∏∞Î∞òÏúºÎ°ú Ìïú Ï¢ÖÌï©Ï†Å ÏãúÏû• Î∂ÑÏÑù</p>
        </div>
        <Button 
          onClick={loadAnalysisHistory} 
          disabled={loading}
          variant="outline"
        >
          <RefreshCw className={`mr-2 h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
          ÏÉàÎ°úÍ≥†Ïπ®
        </Button>
      </div>

      {/* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8">
          <button
            onClick={() => setActiveTab('overview')}
            className={`py-2 px-1 border-b-2 font-medium text-sm ${
              activeTab === 'overview'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
          >
            Í∞úÏöî
          </button>
          <button
            onClick={() => setActiveTab('competitors')}
            className={`py-2 px-1 border-b-2 font-medium text-sm ${
              activeTab === 'competitors'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
          >
            Í≤ΩÏüÅÏÇ¨ Î∂ÑÏÑù
          </button>
          <button
            onClick={() => setActiveTab('trends')}
            className={`py-2 px-1 border-b-2 font-medium text-sm ${
              activeTab === 'trends'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
          >
            ÏãúÏû• Ìä∏Î†åÎìú
          </button>
          <button
            onClick={() => setActiveTab('opportunities')}
            className={`py-2 px-1 border-b-2 font-medium text-sm ${
              activeTab === 'opportunities'
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
          >
            Í∏∞Ìöå/ÏúÑÌóò
          </button>
        </nav>
      </div>

      {/* ÌÉ≠ ÏΩòÌÖêÏ∏† */}
      {activeTab === 'overview' && renderOverview()}
      {activeTab === 'competitors' && renderCompetitorAnalysis()}
      {activeTab === 'trends' && renderMarketTrends()}
      {activeTab === 'opportunities' && renderOpportunitiesThreats()}

      {/* Î∂ÑÏÑù Ïù¥Î†• */}
      {analysisHistory.length > 0 && (
        <Card className="bg-white border border-gray-200">
          <div className="mb-4">
            <h4 className="text-base font-semibold">ÏµúÍ∑º Î∂ÑÏÑù Ïù¥Î†•</h4>
          </div>
          <div className="space-y-2">
            {analysisHistory.slice(0, 5).map((item) => (
              <div
                key={item.id}
                className="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg cursor-pointer"
                onClick={() => setMarketResearch(item)}
              >
                <div className="flex items-center gap-3">
                  {getStatusIcon(item.status)}
                  <div>
                    <p className="text-sm font-medium">AI ÏãúÏû• Ï°∞ÏÇ¨ Î∂ÑÏÑù</p>
                    <p className="text-xs text-gray-500">
                      {new Date(item.created_at).toLocaleDateString()} ‚Ä¢ {item.ai_model_used}
                    </p>
                  </div>
                </div>
                <ChevronRight className="w-4 h-4 text-gray-400" />
              </div>
            ))}
          </div>
        </Card>
      )}

      {/* RFP Î∂ÑÏÑù ÏÑ†ÌÉù Î™®Îã¨ */}
      {showRFPSelector && renderRFPSelector()}
    </div>
  );
}